name: cd

on:
  push:
    branches: [main]

jobs:
    deploy:
        env:
          PROJECT_ID: notely-474004
          REGION: us-central1
          REPO_NAME: notely-ar-repo
          IMAGE: notely
          TAG: latest
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        name: Deploy
        runs-on: ubuntu-latest

        steps:
          - name: Check out code
            uses: actions/checkout@v4

          - name: Set up Go
            uses: actions/setup-go@v5
            with:
              go-version: "1.25.1"

          - name: buildprod.sh
            run: |
              chmod +x ./scripts/buildprod.sh
              ./scripts/buildprod.sh
          - id: 'auth'
            uses: 'google-github-actions/auth@v2'
            with:
              credentials_json: '${{ secrets.GCP_CREDENTIALS }}'

          - name: 'Set up Cloud SDK'
            uses: 'google-github-actions/setup-gcloud@v3'
      
          - name: 'Use gcloud CLI'
            run: 'gcloud info'
        
          - name: gcloud
            run: |
              gcloud builds submit --tag us-central1-docker.pkg.dev/notely-474004/notely-ar-repo/notely:latest .
        
          - name: Install goose
            run: |
              go install github.com/pressly/goose/v3/cmd/goose@latest
              goose -version # should be at least v3.18.0

          - name: migrateup.sh
            run: |
              chmod +x ./scripts/migrateup.sh
              ./scripts/migrateup.sh

          - name: Deploy to Cloud Run
            run: gcloud run deploy notely --image ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO_NAME}/${IMAGE}:${TAG} --region ${REGION} --allow-unauthenticated --project ${PROJECT_ID} --max-instances=4
